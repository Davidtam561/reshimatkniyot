<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyCart</title>
    <link rel="icon" type="image/svg+xml" href="favion.svg">
    <style>
        body{font-family:Arial,sans-serif;background-color:#e0f7fa;color:#00796b;direction:rtl}.category{margin:20px 0}.category-header{cursor:pointer;background-color:#00796b;color:white;padding:10px;border-radius:5px}.category-content{padding:10px;border:1px solid #00796b;border-radius:5px;background-color:#ffffff;display:none;flex-wrap:wrap}#clear-button{margin-top:10px;margin-right:10px;padding:10px;background-color:#d32f2f;color:white;border:none;border-radius:5px;cursor:pointer}.product{flex:1 1 calc(33.333% - 20px);margin:10px;padding:10px;border:1px solid #00796b;border-radius:5px;background-color:#b2ebf2}#shopping-list{width:100%;height:100px;margin-top:20px;padding:10px;border:1px solid #00796b;border-radius:5px;background-color:#ffffff}#copy-button{margin-top:10px;padding:10px;background-color:#00796b;color:white;border:none;border-radius:5px;cursor:pointer}#total-price{margin-top:20px;font-size:1.2em}.highlight{border:2px dashed #00796b}
    </style>
</head>
<div class="category">
    <div class="category-header">בשרים</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="50">בשר בקר - 50 ש"ח</div>
        <div class="product" draggable="true" data-price="30">עוף - 30 ש"ח</div>
        <div class="product" draggable="true" data-price="40">בשר טחון - 40 ש"ח</div>
        <div class="product" draggable="true" data-price="35">קבב - 35 ש"ח</div>
        <div class="product" draggable="true" data-price="45">סטייק - 45 ש"ח</div>
        <div class="product" draggable="true" data-price="55">שניצל - 55 ש"ח</div>
        <div class="product" draggable="true" data-price="25">נקניקיות - 25 ש"ח</div>
        <div class="product" draggable="true" data-price="30">בשר עגל צעיר - 30 ש"ח</div>
    </div>
</div>

<div class="category">
    <div class="category-header">חלבי</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="5">חלב - 5 ש"ח</div>
        <div class="product" draggable="true" data-price="20">גבינה צהובה - 20 ש"ח</div>
        <div class="product" draggable="true" data-price="10">יוגורט - 10 ש"ח</div>
        <div class="product" draggable="true" data-price="15">גבינת קוטג' - 15 ש"ח</div>
        <div class="product" draggable="true" data-price="25">גבינת שמנת - 25 ש"ח</div>
        <div class="product" draggable="true" data-price="30">גבינת פטה - 30 ש"ח</div>
    </div>
</div>

<div class="category">
    <div class="category-header">מאפים</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="8">לחם - 8 ש"ח</div>
        <div class="product" draggable="true" data-price="12">לחמניות - 12 ש"ח</div>
        <div class="product" draggable="true" data-price="15">עוגיות - 15 ש"ח</div>
        <div class="product" draggable="true" data-price="10">פיתה - 10 ש"ח</div>
        <div class="product" draggable="true" data-price="20">באגט - 20 ש"ח</div>
        <div class="product" draggable="true" data-price="25">קרואסון - 25 ש"ח</div>
    </div>
</div>

<div class="category">
    <div class="category-header">ניקיון</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="10">סבון כלים - 10 ש"ח</div>
        <div class="product" draggable="true" data-price="25">אבקת כביסה - 25 ש"ח</div>
        <div class="product" draggable="true" data-price="15">מטליות ניקוי - 15 ש"ח</div>
        <div class="product" draggable="true" data-price="20">מרכך כביסה - 20 ש"ח</div>
        <div class="product" draggable="true" data-price="30">נוזל רצפות - 30 ש"ח</div>
        <div class="product" draggable="true" data-price="35">נוזל חלונות - 35 ש"ח</div>
    </div>
</div>

<div class="category">
    <div class="category-header">ממתקים</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="10">שוקולד - 10 ש"ח</div>
        <div class="product" draggable="true" data-price="5">סוכריות - 5 ש"ח</div>
        <div class="product" draggable="true" data-price="20">עוגות - 20 ש"ח</div>
        <div class="product" draggable="true" data-price="15">חטיף שוקולד - 15 ש"ח</div>
        <div class="product" draggable="true" data-price="25">חטיף אנרגיה - 25 ש"ח</div>
        <div class="product" draggable="true" data-price="9">חטיפי ביסלי 100 גרם - 9 ש"ח</div>
    </div>
</div>

<div class="category">
    <div class="category-header">היגיינה</div>
    <div class="category-content">
        <div class="product" draggable="true" data-price="15">משחת שיניים - 15 ש"ח</div>
        <div class="product" draggable="true" data-price="20">שמפו - 20 ש"ח</div>
        <div class="product" draggable="true" data-price="10">סבון גוף - 10 ש"ח</div>
        <div class="product" draggable="true" data-price="25">מרכך שיער - 25 ש"ח</div>
        <div class="product" draggable="true" data-price="30">דאודורנט - 30 ש"ח</div>
        <div class="product" draggable="true" data-price="35">קרם לחות - 35 ש"ח</div>
    </div>
</div>
 <textarea id="shopping-list" placeholder="גרור את המוצרים לכאן..."></textarea>
    <button id="copy-button">העתק טקסט</button>
    <button id="clear-button">נקה שדה</button>
    <div id="total-price">מחיר משוער: 0 ש"ח</div>
    <script>
        // אתחול משתנים גלובליים
        const shoppingList = document.getElementById('shopping-list');
        let totalSum = 0;

        // פונקציות עזר
        function getClickedLineIndex(target, textarea) {
            const clickPosition = target.selectionStart;
            const text = textarea.value;
            return text.substr(0, clickPosition).split('\n').length - 1;
        }

        function recalculateTotalSum() {
            totalSum = 0;
            const lines = shoppingList.value.split('\n');
            lines.forEach(line => {
                const match = line.match(/(\d+) ש"ח$/);
                if (match) {
                    totalSum += parseInt(match[1]);
                }
            });
            updateTotalPrice();
        }

        function updateTotalPrice() {
            document.getElementById('total-price').textContent = `מחיר משוער: ${totalSum} ש"ח`;
        }

        function addToShoppingList(productText, totalPrice) {
            const productLine = productText + ' [X]\n';
            shoppingList.value += productLine;
            totalSum += totalPrice;
            updateTotalPrice();
            // שמירה ב-localStorage
            saveToLocalStorage();
        }

        function saveToLocalStorage() {
            localStorage.setItem('shoppingList', shoppingList.value);
            localStorage.setItem('totalSum', totalSum.toString());
        }

        // Event Listeners לקטגוריות
        document.querySelectorAll('.category-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                content.style.display = content.style.display === 'none' ? 'flex' : 'none';
            });
        });

        // Event Listeners למוצרים
        document.querySelectorAll('.product').forEach(product => {
            // Drag & Drop events
            product.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', product.textContent);
                e.dataTransfer.setData('price', product.getAttribute('data-price'));
            });

            // Touch events for mobile
            product.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                product.classList.add('dragging');
                product.setAttribute('data-touch-id', touch.identifier);
            });

            product.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const draggingProduct = document.querySelector('.dragging');
                if (draggingProduct && draggingProduct.getAttribute('data-touch-id') == touch.identifier) {
                    const shoppingList = document.getElementById('shopping-list');
                    const rect = shoppingList.getBoundingClientRect();
                    if (touch.clientX >= rect.left && touch.clientX <= rect.right && 
                        touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                        shoppingList.classList.add('highlight');
                    } else {
                        shoppingList.classList.remove('highlight');
                    }
                }
            });

            product.addEventListener('touchend', handleTouchEnd);
        });

        function handleTouchEnd(e) {
            e.preventDefault();
            const draggingProduct = document.querySelector('.dragging');
            if (draggingProduct) {
                const shoppingList = document.getElementById('shopping-list');
                const rect = shoppingList.getBoundingClientRect();
                const touch = e.changedTouches[0];
                if (touch.clientX >= rect.left && touch.clientX <= rect.right && 
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    handleProductDrop(draggingProduct);
                }
                shoppingList.classList.remove('highlight');
                draggingProduct.classList.remove('dragging');
                draggingProduct.removeAttribute('data-touch-id');
            }
        }

        function handleProductDrop(product) {
            const productText = product.textContent;
            const price = product.getAttribute('data-price');
            const quantity = prompt("הכנס כמות / משקל:");
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const totalPrice = price * quantity;
                const productEntry = `${productText} - ${quantity} יחידות - ${totalPrice} ש"ח`;
                addToShoppingList(productEntry, totalPrice);
            } else {
                alert("אנא הכנס כמות / משקל תקין.");
            }
        }

        // Event Listeners לרשימת הקניות
        shoppingList.addEventListener('dragover', (e) => e.preventDefault());
        shoppingList.addEventListener('drop', (e) => {
            e.preventDefault();
            const productText = e.dataTransfer.getData('text/plain');
            const price = e.dataTransfer.getData('price');
            const quantity = prompt("הכנס כמות / משקל:");
            if (quantity && !isNaN(quantity) && quantity > 0) {
                const totalPrice = price * quantity;
                const productEntry = `${productText} - ${quantity} יחידות - ${totalPrice} ש"ח`;
                addToShoppingList(productEntry, totalPrice);
            } else {
                alert("אנא הכנס כמות / משקל תקין.");
            }
        });

        shoppingList.addEventListener('click', (e) => {
            const lines = shoppingList.value.split('\n');
            const clickedLineIndex = getClickedLineIndex(e.target, shoppingList);
            if (lines[clickedLineIndex]?.includes('[X]')) {
                if (confirm('האם למחוק פריט זה מהרשימה?')) {
                    lines.splice(clickedLineIndex, 1);
                    shoppingList.value = lines.join('\n');
                    recalculateTotalSum();
                    saveToLocalStorage();
                }
            }
        });

        // Event Listeners לכפתורים
        document.getElementById('clear-button').addEventListener('click', () => {
            if (shoppingList.value && confirm('האם אתה בטוח שברצונך לנקות את הרשימה?')) {
                shoppingList.value = '';
                totalSum = 0;
                updateTotalPrice();
                saveToLocalStorage();
            }
        });

        document.getElementById('copy-button').addEventListener('click', async () => {
            const totalPriceText = `\n\nמחיר משוער: ${totalSum} ש"ח`;
            const textToCopy = shoppingList.value + totalPriceText;
            try {
                await navigator.clipboard.writeText(textToCopy);
                alert("הטקסט הועתק בהצלחה!");
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert("לא הצלחנו להעתיק את הטקסט. אנא נסה שוב.");
            }
        });

        // טעינת נתונים שמורים בעת טעינת הדף
        window.addEventListener('load', () => {
            const savedList = localStorage.getItem('shoppingList');
            const savedSum = localStorage.getItem('totalSum');
            if (savedList) {
                shoppingList.value = savedList;
                totalSum = Number(savedSum);
                updateTotalPrice();
            }
        });
    </script>
</body>
</html>
